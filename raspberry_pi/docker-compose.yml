version: '3.8'

services:
  museum-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: museum-system
    restart: always
    privileged: true
    network_mode: host
    environment:
      - PYTHONPATH=/app
      - PULSE_RUNTIME_PATH=/run/user/1000/pulse
    volumes:
      # Project code (for live editing)
      - ./:/app:rw
      # Persistent data
      - museum_logs:/app/logs
      - museum_config:/app/config
      - museum_audio:/app/audio
      - museum_videos:/app/videos
      - museum_scenes:/app/scenes
      - museum_web:/app/Web
      # GPIO access
      - /dev/gpiomem:/dev/gpiomem
      - /dev/mem:/dev/mem
      # Audio devices
      - /dev/snd:/dev/snd
      # System devices for hardware access
      - /sys:/sys:ro
      - /proc:/proc:ro
      # PulseAudio socket
      - /run/user/1000/pulse:/run/user/1000/pulse:rw
      # SSH host keys persistence
      - ssh_host_keys:/etc/ssh/ssh_host_keys
    ports:
      - "22:22"     # SSH
      - "1883:1883" # MQTT
      - "5000:5000" # Web Dashboard
    devices:
      - /dev/gpiomem:/dev/gpiomem
      - /dev/mem:/dev/mem
      - /dev/snd:/dev/snd
    depends_on:
      - mqtt-broker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mqtt-broker:
    image: eclipse-mosquitto:2.0
    container_name: museum-mqtt
    restart: always
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./broker/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    command: mosquitto -c /mosquitto/config/mosquitto.conf

  # Optional: Development tools container
  dev-tools:
    image: python:3.11-slim-bullseye
    container_name: museum-dev-tools
    restart: "no"
    profiles:
      - dev
    volumes:
      - ./:/workspace:rw
    working_dir: /workspace
    command: tail -f /dev/null
    network_mode: host

volumes:
  museum_logs:
    driver: local
  museum_config:
    driver: local
  museum_audio:
    driver: local
  museum_videos:
    driver: local
  museum_scenes:
    driver: local
  museum_web:
    driver: local
  mqtt_data:
    driver: local
  mqtt_logs:
    driver: local
  ssh_host_keys:
    driver: local

networks:
  default:
    driver: bridge